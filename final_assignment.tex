% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Project report - Deep Learning for the Analysis of Remote Sensing Imagery from Nano Satellites},
  pdfauthor={Katharina Hovestadt (440 289), Lia Kirsch (437 494), Jannis Fröhlking (439 599)},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-ident, #2 entry spacing
 {% don't indent paragraphs
  \setlength{\parindent}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1 \everypar{\setlength{\hangindent}{\cslhangindent}}\ignorespaces\fi
  % set entry spacing
  \ifnum #2 > 0
  \setlength{\parskip}{#2\baselineskip}
  \fi
 }%
 {}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{#1\hfill\break}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{#1}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{#1}\break}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}

\title{Project report - Deep Learning for the Analysis of Remote Sensing
Imagery from Nano Satellites}
\author{Katharina Hovestadt (440 289), Lia Kirsch (437 494), Jannis
Fröhlking (439 599)}
\date{31 7 2021}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# used libraries}
\FunctionTok{library}\NormalTok{(keras)}
\FunctionTok{library}\NormalTok{(tensorflow)}
\FunctionTok{library}\NormalTok{(tfdatasets)}
\FunctionTok{library}\NormalTok{(purrr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(rsample)}
\FunctionTok{library}\NormalTok{(stars)}
\FunctionTok{library}\NormalTok{(terra)}
\FunctionTok{library}\NormalTok{(raster)}
\FunctionTok{library}\NormalTok{(reticulate)}
\FunctionTok{library}\NormalTok{(mapview)}
\FunctionTok{library}\NormalTok{(dplyr)}
\end{Highlighting}
\end{Shaded}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

This report aims to show the process of exploring the sustainability of
convolutional neural networks (CNNS). The subject of infrastructure
growth due to the World Cup 2022 has been chosen to take up a topic that
is currently being discussed in society and to arouse interest in the
topic of the growing infrastructure around a World Cup.

But also to show which methods, in this case deep learning, can be used
to produce well-founded results that one can rely on. Growth of
infrastructure is a broad spectrum, because under the term
infrastructure the most diverse elements are collected . Therefore, it
needed a specification here. The specification of road growth was chosen
because it is one of the most illustrative examples, which is close to
the reality of life of many people.

Topics that are discussed in society in regard to the world cup 2022 and
are interesting for infrastructure growth can be clustered under the top
themes of sustainability and violation of human rights.

There is a broad discussion about the growth of infrastructure at almost
every major sporting event (European Championship, World Cup, Olympics).
This is also the case at various world championships. In order for a
country to host a World Cup, there are various guidelines that must be
followed. Most countries, however, do not meet these guidelines and have
to present plans that show that they will have a suitable
infrastructure, e.g.~stadiums, hotels, etc. by the start of the World
Cup. In the case of the 2022 World Cup in Qatar, this means that since
the announcement of the 2022 World Cup in Qatar, a massive expansion of
infrastructure has been and is being driven forward. It can be seen that
some stadiums are only built for the World Cup 2022 (Stern 2021).
Furthermore a new airport and other infrastructure like hotels and
public transport systems can be found (Stern 2021). For that reason
there is a huge discussion on the sustainability of the World Cup in
Qatar. Many are of the opinion that stadiums that are only built for the
World Cup and are no longer used afterwards do not correspond to the
sense of sustainable use (Stern 2021). Also the operation of the
stadiums is criticized, since this e.g.~by the cooling in this hot
region, releases much energy (Tobias Rudolf 2021). This type of
discussion is becoming even more important as Qatar has made a promise
to hold the 2022 World Cup in a climate-neutral manner (tz 2021).
Another discussion, which is particularly important in relation to the
development of infrastructure is the way in which the infrastructure is
built and by whom. A huge exploitation of guest workers in several
branches can be found since 2011 in Qatar (Benjamin Best 2021).
According to research by Amnesty International more than 6500 guest
workers have died in Qatar since the World Cup was awarded in 2011 (The
Guardian 2021). But the number of unreported cases seems to be even
higher (The Guardian 2021).

In order to be able to provide a further basis for the discussion on the
expansion of the infrastructure, this report refers to street growth. As
this process is scientifically measurable. Furthermore street growth is
important for infrastructure and networks and could be seen as an
indicator for growth. Therefore high-resolution satellite imagery from
nano satellites was analyzed and classified to answer the question of:

How does the street infrastructure around the Khalifa International
Stadium change from 2017 on according to the Soccer World cup in 2022?

This report shows the different steps that were necessary to answer the
question. The first part focuses on the project goals. The second part
provides an overview about the used methods. This is followed by a
section highlighting how the project was planned and implemented. Part
four focuses on the results found. Finally a section of lessons learned
through the project can be found.

\hypertarget{project-goal}{%
\section{Project Goal}\label{project-goal}}

The aim of this project was the detection of streets around the Khalifa
International Stadium and how it changed from 2017 on according to the
Soccer World Cup in 2022. Therefore several classification methods and
challenges associated with them should be learned. Since the project is
based on convolutional neural networks with \emph{keras} and
\emph{tensorflow} the aim was to understand the key steps when using
deep learning in remote sensing. Also because large amounts of data are
used in this context it was necessary to learn how to use an \emph{AWS}.
This is linked to the challenges coming up when dealing with huge
datasets.

Since a model was build the goal was to understand how to built, train
and predict with it, The aim was to understand how to set up a model and
furthermore to understand which validation methods are suitable for a
good prediction. As an overarching goal the understanding of a deep
learning factor must be mentioned.

\hypertarget{methods}{%
\section{Methods}\label{methods}}

\hypertarget{data}{%
\subsection{Data}\label{data}}

\hypertarget{nano-satellite-images}{%
\subsubsection{Nano Satellite Images}\label{nano-satellite-images}}

The images used for model training and prediction were created by nano
satellites from Planet and are provided by them as PSScene3Band
products, which have a spatial resolution of 3 x 3 meter. We used a
spatial extent located in Bahrain to train the image. The image is a
visual product from the 28th of April, 2021 (see Figure 1).

For prediction and comparison we used images around the Khalifa
International Stadium, Doha (Qatar) every two years from 2017. To
exclude seasonal irregularities we stuck to images of March and April
(2017-04-22, 2019-03-27, 2021-03-18). In Figure 2 the image of 2021 is
plotted.

\hypertarget{street-network-vectors}{%
\subsubsection{Street network vectors}\label{street-network-vectors}}

To create masks for model training we obtained OpenStreetMap shapefiles
of the states from the Gulf Cooperation Council (GCC) from Geofabrik
(OpenStreetMap contributors 2017). The data can be downloaded via
\url{http://download.geofabrik.de/asia/gcc-states-latest-free.shp.zip}.
One of the provided shapefiles contains data about the street network
(gis\_osm\_roads\_free\_1.shp), which we clipped to the spatial extent
of our Bahrain training image via QGIS (QGIS Development Team 2021).

\hypertarget{preprocesssing}{%
\subsection{Preprocesssing}\label{preprocesssing}}

Planet assigns not available pixel values with 0, which impedes
combining images. Before merging images, we therefore assigned pixel
values of 0 with NA values for each image. Because the nano satellite
images of each year consist of multiple images from different swaths, we
then merged single images to have one image covering the entire spatial
extent of one year.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Preprocess satellite images}
\NormalTok{setNAs }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(test\_tile)\{}
  \CommentTok{\# set zero values to NA}
\NormalTok{  test\_tile[test\_tile[]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
  \CommentTok{\# crop to non NA values}
\NormalTok{  test\_tile }\OtherTok{=} \FunctionTok{trim}\NormalTok{(test\_tile)}
  \CommentTok{\# remove fourth band (NIR)}
\NormalTok{  test\_tile }\OtherTok{=} \FunctionTok{dropLayer}\NormalTok{(test\_tile,}\DecValTok{4}\NormalTok{)}
  \FunctionTok{return}\NormalTok{ (test\_tile)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Set path to folder containing Planet satellite images of Bahrain}
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"data/training\_unet/bahrain\_2021.tif"}\NormalTok{))\{}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"data/Bahrain\_2021\_3Band/files"}\NormalTok{)}
\NormalTok{  files }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{".tif$"}\NormalTok{)}
\NormalTok{  filesList }\OtherTok{=} \FunctionTok{as.list}\NormalTok{(files)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(filesList, stack)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(stackList, setNAs)}
\NormalTok{  mosaic\_bahrain }\OtherTok{=} \FunctionTok{mosaic}\NormalTok{(stackList[[}\DecValTok{1}\NormalTok{]],stackList[[}\DecValTok{2}\NormalTok{]],stackList[[}\DecValTok{3}\NormalTok{]], stackList[[}\DecValTok{4}\NormalTok{]],}
                          \AttributeTok{fun =}\NormalTok{ mean)}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"\textasciitilde{}/"}\NormalTok{)}
  \FunctionTok{writeRaster}\NormalTok{(mosaic\_bahrain, }\StringTok{"data/training\_unet/bahrain\_2021.tif"}\NormalTok{)}
\NormalTok{\}}


\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2021.tif"}\NormalTok{))\{}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"data/2021/files"}\NormalTok{)}
\NormalTok{  files }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{".tif$"}\NormalTok{)}
\NormalTok{  filesList }\OtherTok{=} \FunctionTok{as.list}\NormalTok{(files)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(filesList, stack)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(stackList, setNAs)}
\NormalTok{  mosaic\_doha21 }\OtherTok{=} \FunctionTok{mosaic}\NormalTok{(stackList[[}\DecValTok{1}\NormalTok{]],stackList[[}\DecValTok{2}\NormalTok{]],}\AttributeTok{fun =}\NormalTok{ mean)}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"\textasciitilde{}/"}\NormalTok{)}
  \FunctionTok{writeRaster}\NormalTok{(mosaic\_doha21, }\StringTok{"data/testarea\_unet/doha\_2021.tif"}\NormalTok{)}
\NormalTok{\}}

\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2019.tif"}\NormalTok{))\{}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"data/2019/files"}\NormalTok{)}
\NormalTok{  files }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{".tif$"}\NormalTok{)}
\NormalTok{  filesList }\OtherTok{=} \FunctionTok{as.list}\NormalTok{(files)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(filesList, stack)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(stackList, setNAs)}
\NormalTok{  mosaic\_doha19 }\OtherTok{=} \FunctionTok{mosaic}\NormalTok{(stackList[[}\DecValTok{1}\NormalTok{]],stackList[[}\DecValTok{2}\NormalTok{]],}\AttributeTok{fun =}\NormalTok{ mean)}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"\textasciitilde{}/"}\NormalTok{)}
  \FunctionTok{writeRaster}\NormalTok{(mosaic\_doha19, }\StringTok{"data/testarea\_unet/doha\_2019.tif"}\NormalTok{)}
\NormalTok{\}}

\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{))\{}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"data/2017/files"}\NormalTok{)}
\NormalTok{  files }\OtherTok{=} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{".tif$"}\NormalTok{)}
\NormalTok{  filesList }\OtherTok{=} \FunctionTok{as.list}\NormalTok{(files)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(filesList, stack)}
\NormalTok{  stackList }\OtherTok{=} \FunctionTok{lapply}\NormalTok{(stackList, setNAs)}
\NormalTok{  mosaic\_doha17 }\OtherTok{=} \FunctionTok{mosaic}\NormalTok{(stackList[[}\DecValTok{1}\NormalTok{]],stackList[[}\DecValTok{2}\NormalTok{]],}\AttributeTok{fun =}\NormalTok{ mean)}
  \FunctionTok{setwd}\NormalTok{(}\StringTok{"\textasciitilde{}/"}\NormalTok{)}
  \FunctionTok{writeRaster}\NormalTok{(mosaic\_doha17, }\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot of Bahrain-1} 

}

\caption{Training area in Bahrain (2021)}\label{fig:plot of Bahrain}
\end{figure}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot doha rgb-1} 

}

\caption{Test area in Doha (2021)}\label{fig:plot doha rgb}
\end{figure}

To obtain accurate masks of the street network, a buffer was applied on
the main roads according to their feature class. The buffer size
depended on the importance of the road, from trunk roads with buffer
size of 6 cells to tertiary roads with buffer size of 3 cells. After
that the vector file was rasterized.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"data/testarea\_unet/street\_mask.tif"}\NormalTok{))\{}
  \CommentTok{\# Preprocess street shapefile}
  \CommentTok{\# load planet image of train area}
\NormalTok{  st\_bahrain }\OtherTok{=} \FunctionTok{stack}\NormalTok{(}\StringTok{"data/training\_unet/bahrain\_2021.tif"}\NormalTok{)}
  \CommentTok{\# load openstreetmap data of the streets}
\NormalTok{  streets\_all }\OtherTok{=} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data/shp/streets\_osm.shp"}\NormalTok{)}
  \CommentTok{\# transform osm data to crs of bahrain image}
\NormalTok{  streets\_utm }\OtherTok{=} \FunctionTok{st\_transform}\NormalTok{(streets\_all, }\AttributeTok{crs =} \FunctionTok{crs}\NormalTok{(st\_bahrain))}
  \CommentTok{\# crop shp to satellite image}
\NormalTok{  streets }\OtherTok{=} \FunctionTok{st\_crop}\NormalTok{(streets\_utm, }\FunctionTok{st\_bbox}\NormalTok{(st\_bahrain))}
  
  \CommentTok{\# Rasterize streets shapefile}
  \CommentTok{\# creates a SpatVector object}
\NormalTok{  v\_lines }\OtherTok{=} \FunctionTok{vect}\NormalTok{(streets)}
  \CommentTok{\# prepare the output raster size}
\NormalTok{  r }\OtherTok{=} \FunctionTok{rast}\NormalTok{(v\_lines, }\AttributeTok{ncol =} \FunctionTok{ncol}\NormalTok{(st\_bahrain), }\AttributeTok{nrow =} \FunctionTok{nrow}\NormalTok{(st\_bahrain))}
  \CommentTok{\# first raster, where each street type has the same width}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{rasterize}\NormalTok{(v\_lines, r, }\AttributeTok{touches =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{background =} \DecValTok{0}\NormalTok{)}
  
  \CommentTok{\# Buffer streets to get better rasterization result, because main roads have a higher width}
\NormalTok{  primaries }\OtherTok{=}\NormalTok{ streets[streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"primary"}\NormalTok{,]}
\NormalTok{  secondaries }\OtherTok{=}\NormalTok{ streets[streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"secondary"}\NormalTok{,]}
\NormalTok{  tertiaries }\OtherTok{=}\NormalTok{ streets[streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"tertiary"}\NormalTok{,]}
\NormalTok{  trunks }\OtherTok{=}\NormalTok{ streets[streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"trunk"}\NormalTok{,]}
  
\NormalTok{  poly\_streets }\OtherTok{=} \FunctionTok{rbind}\NormalTok{(primaries,secondaries, tertiaries, trunks)}
  
  \FunctionTok{st\_geometry}\NormalTok{(poly\_streets[poly\_streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"trunk"}\NormalTok{,]) }\OtherTok{=} \FunctionTok{st\_geometry}\NormalTok{(}
    \FunctionTok{st\_buffer}\NormalTok{(trunks, }\AttributeTok{dist =} \DecValTok{6}\NormalTok{))}
  \FunctionTok{st\_geometry}\NormalTok{(poly\_streets[poly\_streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"primary"}\NormalTok{,]) }\OtherTok{=} \FunctionTok{st\_geometry}\NormalTok{(}
    \FunctionTok{st\_buffer}\NormalTok{(primaries, }\AttributeTok{dist =} \DecValTok{5}\NormalTok{))}
  \FunctionTok{st\_geometry}\NormalTok{(poly\_streets[poly\_streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"secondary"}\NormalTok{,]) }\OtherTok{=} \FunctionTok{st\_geometry}\NormalTok{(}
    \FunctionTok{st\_buffer}\NormalTok{(secondaries, }\AttributeTok{dist =} \DecValTok{4}\NormalTok{))}
  \FunctionTok{st\_geometry}\NormalTok{(poly\_streets[poly\_streets}\SpecialCharTok{$}\NormalTok{fclass }\SpecialCharTok{==} \StringTok{"tertiary"}\NormalTok{,]) }\OtherTok{=} \FunctionTok{st\_geometry}\NormalTok{(}
    \FunctionTok{st\_buffer}\NormalTok{(tertiaries, }\AttributeTok{dist =} \DecValTok{3}\NormalTok{))}
  
  \CommentTok{\# second raster with the bis streets}
\NormalTok{  v\_poly }\OtherTok{=} \FunctionTok{vect}\NormalTok{(poly\_streets)}
\NormalTok{  r\_poly }\OtherTok{=} \FunctionTok{rast}\NormalTok{(v\_poly, }\AttributeTok{ncol =} \FunctionTok{ncol}\NormalTok{(st\_bahrain), }\AttributeTok{nrow =} \FunctionTok{nrow}\NormalTok{(st\_bahrain), }\AttributeTok{extent =} \FunctionTok{ext}\NormalTok{(x))}
\NormalTok{  x\_poly }\OtherTok{\textless{}{-}} \FunctionTok{rasterize}\NormalTok{(v\_poly, r\_poly, }\AttributeTok{touches =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{background =} \DecValTok{0}\NormalTok{)}
  \CommentTok{\# Combine resulting two raster layers}
\NormalTok{  result }\OtherTok{=} \FunctionTok{max}\NormalTok{(x\_poly,x)}
  \FunctionTok{writeRaster}\NormalTok{(result, }\StringTok{"data/training\_unet/street\_mask.tif"}\NormalTok{, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The white areas in Figure 3. show the streets (TRUE) while black areas
represent no streets (FALSE). Bigger streets have a bigger size than
smaller streets due to their respective buffers.

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot street mask-1} 

}

\caption{Street mask}\label{fig:plot street mask}
\end{figure}

\hypertarget{model-building}{%
\subsection{Model Building}\label{model-building}}

The model building workflow follows the pixel-by-pixel classification
part of the tutorial ``Introduction to Deep Learning in R for the
Analysis of UAV-based Remote Sensing Data`` by Christian Knoth. This
allows for the localisation of desired features in a target image based
on a U-net architecture (Olaf Ronneberger, Philipp Fischer, and Thomas
Brox 2015). The architecture consists of two parts. The first part is
the contracting path, which extracts spatial patterns and is made of
convolutional and max pooling layers. In the second part, the expansive
path, the maps of spatial patterns are resampled back to the resolution
of the input image by convolutional and upsampling layers combined with
concatenated layers of the original patterns.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
  \DocumentationTok{\#\# Pixelwise classification of streets in Doha, Qatar}
  \DocumentationTok{\#\# From image to pixel{-}by{-}pixel classification}
  
  \DocumentationTok{\#\# we start with the "contratcing path"\#\#}
  \CommentTok{\# input}
\NormalTok{  input\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_input}\NormalTok{(}\AttributeTok{shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{,}\DecValTok{3}\NormalTok{))}
  
  \CommentTok{\#conv block 1}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(input\_tensor,}\AttributeTok{filters =} \DecValTok{64}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{),}
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  conc\_tensor2 }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{64}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{), }
                                \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_max\_pooling\_2d}\NormalTok{(conc\_tensor2)}
  
  \CommentTok{\#conv block 2}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{128}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{), }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  conc\_tensor1 }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{128}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{), }
                                \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_max\_pooling\_2d}\NormalTok{(conc\_tensor1)}
  
  \CommentTok{\#"bottom curve" of unet}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{256}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{), }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{256}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{), }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{,}\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \DocumentationTok{\#\#  this is where the expanding path begins \#\#}
  
  \CommentTok{\# upsampling block 1}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{128}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{)}
\NormalTok{                                         ,}\AttributeTok{strides =} \DecValTok{2}\NormalTok{,}\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(conc\_tensor1,unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{128}\NormalTok{, }\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{),}
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{128}\NormalTok{, }\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{),}
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# upsampling block 2}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{64}\NormalTok{,}\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{),}
                                         \AttributeTok{strides =} \DecValTok{2}\NormalTok{,}\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(conc\_tensor2,unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{64}\NormalTok{, }\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{),}
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{64}\NormalTok{, }\AttributeTok{kernel\_size =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{),}
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# output}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{1}\NormalTok{,}\AttributeTok{kernel\_size =} \DecValTok{1}\NormalTok{, }
                               \AttributeTok{activation =} \StringTok{"sigmoid"}\NormalTok{)}
  
  \CommentTok{\# combine final unet\_tensor (carrying all the transformations applied through the layers)}
  \CommentTok{\# with input\_tensor to create model}
\NormalTok{  unet\_model }\OtherTok{\textless{}{-}} \FunctionTok{keras\_model}\NormalTok{(}\AttributeTok{inputs =}\NormalTok{ input\_tensor, }\AttributeTok{outputs =}\NormalTok{ unet\_tensor)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
  
  \DocumentationTok{\#\# load pretrained vgg16 and use part of it as contracting path (feature extraction) \#\#}
\NormalTok{  vgg16\_feat\_extr }\OtherTok{\textless{}{-}} \FunctionTok{application\_vgg16}\NormalTok{(}\AttributeTok{weights =} \StringTok{"imagenet"}\NormalTok{, }\AttributeTok{include\_top =} \ConstantTok{FALSE}\NormalTok{, }
                                       \AttributeTok{input\_shape =} \FunctionTok{c}\NormalTok{ (}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{,}\DecValTok{3}\NormalTok{))}
  
  \CommentTok{\# optionally freeze first layers to prevent changing of their weights, }
  \CommentTok{\# either whole convbase or only certain layers}
  \CommentTok{\# freeze\_weights(vgg16\_feat\_extr) \#or:}
  \CommentTok{\# freeze\_weights(vgg16\_feat\_extr, to = "block1\_pool")}
  
  \CommentTok{\# we\textquotesingle{}ll not use the whole model but only up to layer 15}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}}\NormalTok{ vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{layers[[}\DecValTok{15}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{output}
  
  \DocumentationTok{\#\# add the second part of \textquotesingle{}U\textquotesingle{} for segemntation \#\#}
  
  \CommentTok{\# "bottom curve" of U{-}net}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{1024}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{1024}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# upsampling block 1}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{512}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{2}\NormalTok{, }
                                         \AttributeTok{strides =} \DecValTok{2}\NormalTok{, }\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{layers[[}\DecValTok{14}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{output, unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{512}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{512}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# upsampling block 2}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{256}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{2}\NormalTok{, }
                                         \AttributeTok{strides =} \DecValTok{2}\NormalTok{, }\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{layers[[}\DecValTok{10}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{output, unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{256}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor,}\AttributeTok{filters =} \DecValTok{256}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# upsampling block 3}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{128}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{2}\NormalTok{, }
                                         \AttributeTok{strides =} \DecValTok{2}\NormalTok{, }\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{layers[[}\DecValTok{6}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{output, unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{128}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{128}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# upsampling block 4}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d\_transpose}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{64}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{2}\NormalTok{, }
                                         \AttributeTok{strides =} \DecValTok{2}\NormalTok{, }\AttributeTok{padding =} \StringTok{"same"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_concatenate}\NormalTok{(}\FunctionTok{list}\NormalTok{(vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{layers[[}\DecValTok{3}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{output, unet\_tensor))}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{64}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{64}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{3}\NormalTok{, }
                               \AttributeTok{padding =} \StringTok{"same"}\NormalTok{, }\AttributeTok{activation =} \StringTok{"relu"}\NormalTok{)}
  
  \CommentTok{\# final output}
\NormalTok{  unet\_tensor }\OtherTok{\textless{}{-}} \FunctionTok{layer\_conv\_2d}\NormalTok{(unet\_tensor, }\AttributeTok{filters =} \DecValTok{1}\NormalTok{, }\AttributeTok{kernel\_size =} \DecValTok{1}\NormalTok{, }
                               \AttributeTok{activation =} \StringTok{"sigmoid"}\NormalTok{)}
  
  \CommentTok{\# create model from tensors}
\NormalTok{  pretrained\_unet }\OtherTok{\textless{}{-}} \FunctionTok{keras\_model}\NormalTok{(}\AttributeTok{inputs =}\NormalTok{ vgg16\_feat\_extr}\SpecialCharTok{$}\NormalTok{input, }\AttributeTok{outputs =}\NormalTok{ unet\_tensor)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spectral\_augmentation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(img) \{}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_brightness}\NormalTok{(img, }\AttributeTok{max\_delta =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_contrast}\NormalTok{(img, }\AttributeTok{lower =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{upper =} \FloatTok{1.2}\NormalTok{)}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_saturation}\NormalTok{(img, }\AttributeTok{lower =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{upper =} \FloatTok{1.2}\NormalTok{)}
    \CommentTok{\# make sure we still are between 0 and 1}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\FunctionTok{clip\_by\_value}\NormalTok{(img,}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#adapted from: https://blogs.rstudio.com/ai/posts/2019{-}08{-}23{-}unet/ (accessed 2020{-}08{-}12)}
\NormalTok{dl\_prepare\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{files=}\ConstantTok{NULL}\NormalTok{, train, }\AttributeTok{predict=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{subsets\_path=}\ConstantTok{NULL}\NormalTok{, }
                            \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }\AttributeTok{batch\_size =}\NormalTok{ 10L) \{}

  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{predict)\{}
    \CommentTok{\#function for random change of saturation,brightness and hue,}
    \CommentTok{\#will be used as part of the augmentation}
\NormalTok{    spectral\_augmentation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(img) \{}
\NormalTok{      img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_brightness}\NormalTok{(img, }\AttributeTok{max\_delta =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{      img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_contrast}\NormalTok{(img, }\AttributeTok{lower =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{upper =} \FloatTok{1.1}\NormalTok{)}
\NormalTok{      img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{random\_saturation}\NormalTok{(img, }\AttributeTok{lower =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{upper =} \FloatTok{1.1}\NormalTok{)}
      \CommentTok{\# make sure we still are between 0 and 1}
\NormalTok{      img }\OtherTok{\textless{}{-}}\NormalTok{ tf}\SpecialCharTok{$}\FunctionTok{clip\_by\_value}\NormalTok{(img, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{    \}}

    \CommentTok{\#create a tf\_dataset from the input data.frame}
    \CommentTok{\#right now still containing only paths to images}
\NormalTok{    dataset }\OtherTok{\textless{}{-}} \FunctionTok{tensor\_slices\_dataset}\NormalTok{(files)}

    \CommentTok{\#use dataset\_map to apply function on each record of the dataset}
    \CommentTok{\#(each record being a list with two items: img and mask), the}
    \CommentTok{\#function is list\_modify, which modifies the list items}
    \CommentTok{\#\textquotesingle{}img\textquotesingle{} and \textquotesingle{}mask\textquotesingle{} by using the results of applying decode\_jpg on the img and the mask   }
    \CommentTok{\#{-}\textgreater{} i.e. jpgs are loaded and placed where the paths to the files were }
    \CommentTok{\# (for each record in dataset)}
\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
        \FunctionTok{list\_modify}\NormalTok{(.x,}\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{decode\_jpeg}\NormalTok{(tf}\SpecialCharTok{$}\NormalTok{io}\SpecialCharTok{$}\FunctionTok{read\_file}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img)),}
                       \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{decode\_jpeg}\NormalTok{(tf}\SpecialCharTok{$}\NormalTok{io}\SpecialCharTok{$}\FunctionTok{read\_file}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask))))}

    \CommentTok{\#convert to float32:}
    \CommentTok{\#for each record in dataset, both its list items are modyfied}
    \CommentTok{\#by the result of applying convert\_image\_dtype to them}
\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
        \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{convert\_image\_dtype}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img, }\AttributeTok{dtype =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{float32),}
                        \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{convert\_image\_dtype}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask, }\AttributeTok{dtype =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{float32)))}

    \CommentTok{\#resize:}
    \CommentTok{\#for each record in dataset, both its list items are modified}
    \CommentTok{\#by the results of applying resize to them}
\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
        \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{resize}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img, }\AttributeTok{size =} \FunctionTok{shape}\NormalTok{(model\_input\_shape[}\DecValTok{1}\NormalTok{],}
\NormalTok{                                                                   model\_input\_shape[}\DecValTok{2}\NormalTok{])),}
                        \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{resize}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask, }\AttributeTok{size =} \FunctionTok{shape}\NormalTok{(model\_input\_shape[}\DecValTok{1}\NormalTok{], }
\NormalTok{                                                                     model\_input\_shape[}\DecValTok{2}\NormalTok{]))))}

    \CommentTok{\# data augmentation performed on training set only}
    \ControlFlowTok{if}\NormalTok{ (train) \{}

      \CommentTok{\#augmentation 1: flip left right, including random change of}
      \CommentTok{\#saturation, brightness and contrast}

      \CommentTok{\#for each record in dataset, only the img item is modified by the result}
      \CommentTok{\#of applying spectral\_augmentation to it}
\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =} \FunctionTok{spectral\_augmentation}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img)))}

      \CommentTok{\#...as opposed to this, flipping is applied to img and mask of each record}
\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(augmentation, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_left\_right}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img),}
                          \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_left\_right}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask)))}

\NormalTok{      dataset\_augmented }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_concatenate}\NormalTok{(dataset,augmentation)}

      \CommentTok{\#augmentation 2: flip up down,}
      \CommentTok{\#including random change of saturation, brightness and contrast}
\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =} \FunctionTok{spectral\_augmentation}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img)))}

\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(augmentation, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_up\_down}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img),}
                          \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_up\_down}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask)))}

\NormalTok{      dataset\_augmented }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_concatenate}\NormalTok{(dataset\_augmented,augmentation)}

      \CommentTok{\#augmentation 3: flip left right AND up down,}
      \CommentTok{\#including random change of saturation, brightness and contrast}

\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =} \FunctionTok{spectral\_augmentation}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img)))}

\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(augmentation, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_left\_right}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img),}
                          \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_left\_right}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask)))}

\NormalTok{      augmentation }\OtherTok{\textless{}{-}}
        \FunctionTok{dataset\_map}\NormalTok{(augmentation, }\ControlFlowTok{function}\NormalTok{(.x)}
          \FunctionTok{list\_modify}\NormalTok{(.x, }\AttributeTok{img =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_up\_down}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{img),}
                          \AttributeTok{mask =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{flip\_up\_down}\NormalTok{(.x}\SpecialCharTok{$}\NormalTok{mask)))}

\NormalTok{      dataset\_augmented }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_concatenate}\NormalTok{(dataset\_augmented,augmentation)}

\NormalTok{    \}}

    \CommentTok{\# shuffling on training set only}
    \ControlFlowTok{if}\NormalTok{ (train) \{}
\NormalTok{      dataset }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_shuffle}\NormalTok{(dataset\_augmented, }\AttributeTok{buffer\_size =}\NormalTok{ batch\_size}\SpecialCharTok{*}\DecValTok{128}\NormalTok{)}
\NormalTok{    \}}

    \CommentTok{\# train in batches; batch size might need to be adapted depending on}
    \CommentTok{\# available memory}
\NormalTok{    dataset }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_batch}\NormalTok{(dataset, batch\_size)}

    \CommentTok{\# output needs to be unnamed}
\NormalTok{    dataset }\OtherTok{\textless{}{-}}  \FunctionTok{dataset\_map}\NormalTok{(dataset, unname)}

\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
    \CommentTok{\#make sure subsets are read in in correct order}
    \CommentTok{\#so that they can later be reassembled correctly}
    \CommentTok{\#needs files to be named accordingly (only number)}
\NormalTok{    o }\OtherTok{\textless{}{-}} \FunctionTok{order}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(tools}\SpecialCharTok{::}\FunctionTok{file\_path\_sans\_ext}\NormalTok{(}\FunctionTok{basename}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(subsets\_path)))))}
\NormalTok{    subset\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(subsets\_path, }\AttributeTok{full.names =}\NormalTok{ T)[o]}

\NormalTok{    dataset }\OtherTok{\textless{}{-}} \FunctionTok{tensor\_slices\_dataset}\NormalTok{(subset\_list)}

\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
\NormalTok{        tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{decode\_jpeg}\NormalTok{(tf}\SpecialCharTok{$}\NormalTok{io}\SpecialCharTok{$}\FunctionTok{read\_file}\NormalTok{(.x)))}

\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
\NormalTok{        tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{convert\_image\_dtype}\NormalTok{(.x, }\AttributeTok{dtype =}\NormalTok{ tf}\SpecialCharTok{$}\NormalTok{float32))}

\NormalTok{    dataset }\OtherTok{\textless{}{-}}
      \FunctionTok{dataset\_map}\NormalTok{(dataset, }\ControlFlowTok{function}\NormalTok{(.x)}
\NormalTok{        tf}\SpecialCharTok{$}\NormalTok{image}\SpecialCharTok{$}\FunctionTok{resize}\NormalTok{(.x, }\AttributeTok{size =} \FunctionTok{shape}\NormalTok{(model\_input\_shape[}\DecValTok{1}\NormalTok{], model\_input\_shape[}\DecValTok{2}\NormalTok{])))}

\NormalTok{    dataset }\OtherTok{\textless{}{-}} \FunctionTok{dataset\_batch}\NormalTok{(dataset, batch\_size)}
\NormalTok{    dataset }\OtherTok{\textless{}{-}}  \FunctionTok{dataset\_map}\NormalTok{(dataset, unname)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{classification}{%
\subsection{Classification}\label{classification}}

In the next step the Doha images were prepared for predictions again by
the creation of subsets. The model was used to predict street pixels on
the subsets and then the subsets were rebuilt to the original extent.
Following up, we decided to convert the resulting percentages of how
likely the pixel is to be a street pixel into a binary classification
street/no-street. As a threshold for a street pixel, we selected a value
of at least 0.3. To compare the street network growth we created
histograms of pixel values for each year.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create subsets for the unet training}
\NormalTok{dl\_subsets }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(inputrst, targetsize, targetdir, }\AttributeTok{targetname=}\StringTok{""}\NormalTok{, }
                       \AttributeTok{img\_info\_only =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{is\_mask =} \ConstantTok{FALSE}\NormalTok{)\{}
  \FunctionTok{require}\NormalTok{(jpeg)}
  \FunctionTok{require}\NormalTok{(raster)}

  \CommentTok{\#determine next number of quadrats in x and y direction, by simple rounding}
\NormalTok{  targetsizeX }\OtherTok{\textless{}{-}}\NormalTok{ targetsize[}\DecValTok{1}\NormalTok{]}
\NormalTok{  targetsizeY }\OtherTok{\textless{}{-}}\NormalTok{ targetsize[}\DecValTok{2}\NormalTok{]}
\NormalTok{  inputX }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(inputrst)}
\NormalTok{  inputY }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(inputrst)}

  \CommentTok{\#determine dimensions of raster so that}
  \CommentTok{\#it can be split by whole number of subsets (by shrinking it)}
  \ControlFlowTok{while}\NormalTok{(inputX}\SpecialCharTok{\%\%}\NormalTok{targetsizeX}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    inputX }\OtherTok{=}\NormalTok{ inputX}\DecValTok{{-}1}  
\NormalTok{  \}}
  \ControlFlowTok{while}\NormalTok{(inputY}\SpecialCharTok{\%\%}\NormalTok{targetsizeY}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    inputY }\OtherTok{=}\NormalTok{ inputY}\DecValTok{{-}1}    
\NormalTok{  \}}

  \CommentTok{\#determine difference}
\NormalTok{  diffX }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(inputrst)}\SpecialCharTok{{-}}\NormalTok{inputX}
\NormalTok{  diffY }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(inputrst)}\SpecialCharTok{{-}}\NormalTok{inputY}

  \CommentTok{\#determine new dimensions of raster and crop,}
  \CommentTok{\#cutting evenly on all sides if possible}
\NormalTok{  newXmin }\OtherTok{\textless{}{-}} \FunctionTok{floor}\NormalTok{(diffX}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}
\NormalTok{  newXmax }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(inputrst)}\SpecialCharTok{{-}}\FunctionTok{ceiling}\NormalTok{(diffX}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}\SpecialCharTok{{-}}\DecValTok{1}
\NormalTok{  newYmin }\OtherTok{\textless{}{-}} \FunctionTok{floor}\NormalTok{(diffY}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}
\NormalTok{  newYmax }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(inputrst)}\SpecialCharTok{{-}}\FunctionTok{ceiling}\NormalTok{(diffY}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}\SpecialCharTok{{-}}\DecValTok{1}
\NormalTok{  rst\_cropped }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{(}\FunctionTok{crop}\NormalTok{(inputrst, }\FunctionTok{extent}\NormalTok{(inputrst,newYmin,}
\NormalTok{                                                        newYmax,newXmin,newXmax)))}
\NormalTok{    agg }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{(}\FunctionTok{aggregate}\NormalTok{(rst\_cropped[[}\DecValTok{1}\NormalTok{]],}\FunctionTok{c}\NormalTok{(targetsizeX,targetsizeY)))}
\NormalTok{    agg[]    }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncell}\NormalTok{(agg))}
\NormalTok{    agg\_poly }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{(}\FunctionTok{rasterToPolygons}\NormalTok{(agg))}
    \FunctionTok{names}\NormalTok{(agg\_poly) }\OtherTok{\textless{}{-}} \StringTok{"polis"}
\NormalTok{    pb }\OtherTok{\textless{}{-}} \FunctionTok{txtProgressBar}\NormalTok{(}\AttributeTok{min =} \DecValTok{0}\NormalTok{, }\AttributeTok{max =} \FunctionTok{ncell}\NormalTok{(agg), }\AttributeTok{style =} \DecValTok{3}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncell}\NormalTok{(agg)) \{}
      \CommentTok{\# rasterOptions(tmpdir=tmpdir)}
      \FunctionTok{setTxtProgressBar}\NormalTok{(pb, i)}
\NormalTok{      e1  }\OtherTok{\textless{}{-}} \FunctionTok{extent}\NormalTok{(agg\_poly[agg\_poly}\SpecialCharTok{$}\NormalTok{polis}\SpecialCharTok{==}\NormalTok{i,])}
\NormalTok{      subs }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{(}\FunctionTok{crop}\NormalTok{(rst\_cropped,e1))}
      \CommentTok{\#rescale to 0{-}1, for jpeg export}
      \ControlFlowTok{if}\NormalTok{(is\_mask}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{}
\NormalTok{        subs }\OtherTok{\textless{}{-}} \FunctionTok{suppressMessages}\NormalTok{((subs}\SpecialCharTok{{-}}\FunctionTok{cellStats}\NormalTok{(subs,}\StringTok{"min"}\NormalTok{))}\SpecialCharTok{/}\NormalTok{(}\FunctionTok{cellStats}\NormalTok{(subs,}\StringTok{"max"}\NormalTok{)}\SpecialCharTok{{-}}
                                                                 \FunctionTok{cellStats}\NormalTok{(subs,}\StringTok{"min"}\NormalTok{)))}
\NormalTok{      \}}
      \CommentTok{\#write jpg}
      \FunctionTok{writeJPEG}\NormalTok{(}\FunctionTok{as.array}\NormalTok{(subs),}\AttributeTok{target =} \FunctionTok{paste0}\NormalTok{(targetdir,targetname,i,}\StringTok{".jpg"}\NormalTok{),}\AttributeTok{quality =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{close}\NormalTok{(pb)}
    \FunctionTok{rm}\NormalTok{(subs,agg,agg\_poly)}
    \FunctionTok{gc}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(rst\_cropped)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Function for Predictions}
\NormalTok{rebuild\_img }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pred\_subsets,out\_path,target\_rst)\{}
  \FunctionTok{require}\NormalTok{(raster)}
  \FunctionTok{require}\NormalTok{(gdalUtils)}
  \FunctionTok{require}\NormalTok{(stars)}


\NormalTok{  subset\_pixels\_x }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(pred\_subsets[}\DecValTok{1}\NormalTok{,,,])}
\NormalTok{  subset\_pixels\_y }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(pred\_subsets[}\DecValTok{1}\NormalTok{,,,])}
\NormalTok{  tiles\_rows }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(target\_rst)}\SpecialCharTok{/}\NormalTok{subset\_pixels\_y}
\NormalTok{  tiles\_cols }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(target\_rst)}\SpecialCharTok{/}\NormalTok{subset\_pixels\_x}

  \CommentTok{\# load target image to determine dimensions}
\NormalTok{   target\_stars }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_stars}\NormalTok{(target\_rst,}\AttributeTok{proxy=}\NormalTok{F)}
   \CommentTok{\#prepare subfolder for output}
\NormalTok{   result\_folder }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(out\_path,}\StringTok{"out"}\NormalTok{)}
   \ControlFlowTok{if}\NormalTok{(}\FunctionTok{dir.exists}\NormalTok{(result\_folder))\{}
     \FunctionTok{unlink}\NormalTok{(result\_folder,}\AttributeTok{recursive =}\NormalTok{ T)}
\NormalTok{   \}}
   \FunctionTok{dir.create}\NormalTok{(}\AttributeTok{path =}\NormalTok{ result\_folder)}

  \CommentTok{\#for each tile, create a stars from corresponding predictions,}
  \CommentTok{\#assign dimensions using original/target image, and save as tif:}
  \ControlFlowTok{for}\NormalTok{ (crow }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{tiles\_rows)\{}
    \ControlFlowTok{for}\NormalTok{ (ccol }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{tiles\_cols)\{}
\NormalTok{      i }\OtherTok{\textless{}{-}}\NormalTok{ (crow}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\FunctionTok{floor}\NormalTok{(tiles\_cols) }\SpecialCharTok{+}\NormalTok{ (ccol}\DecValTok{{-}1}\NormalTok{) }\SpecialCharTok{+}\DecValTok{1}

\NormalTok{      dimx }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(((ccol}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{subset\_pixels\_x}\SpecialCharTok{+}\DecValTok{1}\NormalTok{),(ccol}\SpecialCharTok{*}\NormalTok{subset\_pixels\_x))}
\NormalTok{      dimy }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(((crow}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{subset\_pixels\_y}\SpecialCharTok{+}\DecValTok{1}\NormalTok{),(crow}\SpecialCharTok{*}\NormalTok{subset\_pixels\_y))}
\NormalTok{      cstars }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_stars}\NormalTok{(}\FunctionTok{t}\NormalTok{(pred\_subsets[i,,,}\DecValTok{1}\NormalTok{]))}
      \FunctionTok{attr}\NormalTok{(cstars,}\StringTok{"dimensions"}\NormalTok{)[[}\DecValTok{2}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{delta}\OtherTok{=}\SpecialCharTok{{-}}\DecValTok{1}
      \CommentTok{\#set dimensions using original raster}
      \FunctionTok{st\_dimensions}\NormalTok{(cstars) }\OtherTok{\textless{}{-}} \FunctionTok{st\_dimensions}\NormalTok{(target\_stars[,dimx[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\NormalTok{dimx[}\DecValTok{2}\NormalTok{],dimy[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\NormalTok{dimy[}\DecValTok{2}\NormalTok{]])[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]}

      \FunctionTok{write\_stars}\NormalTok{(cstars,}\AttributeTok{dsn =} \FunctionTok{paste0}\NormalTok{(result\_folder,}\StringTok{"/\_out\_"}\NormalTok{,i,}\StringTok{".tif"}\NormalTok{))}
\NormalTok{    \}}
\NormalTok{  \}}

\NormalTok{  starstiles }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(result\_folder,}\AttributeTok{full.names =}\NormalTok{ T),}\AttributeTok{mode =} \StringTok{"character"}\NormalTok{)}
  \FunctionTok{gdalbuildvrt}\NormalTok{(starstiles,}\FunctionTok{paste0}\NormalTok{(result\_folder,}\StringTok{"/mosaic.vrt"}\NormalTok{))}
  \FunctionTok{gdalwarp}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(result\_folder,}\StringTok{"/mosaic.vrt"}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(result\_folder,}\StringTok{"/mosaic.tif"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Inspecting your network}
\NormalTok{plot\_layer\_activations }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(img\_path, model, activations\_layers,channels)\{}


\NormalTok{  model\_input\_size }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model}\SpecialCharTok{$}\NormalTok{input\_shape[[}\DecValTok{2}\NormalTok{]], model}\SpecialCharTok{$}\NormalTok{input\_shape[[}\DecValTok{3}\NormalTok{]])}

  \CommentTok{\#preprocess image for the model}
\NormalTok{  img }\OtherTok{\textless{}{-}} \FunctionTok{image\_load}\NormalTok{(img\_path, }\AttributeTok{target\_size =}\NormalTok{  model\_input\_size) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{image\_to\_array}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{array\_reshape}\NormalTok{(}\AttributeTok{dim =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, model\_input\_size[}\DecValTok{1}\NormalTok{], model\_input\_size[}\DecValTok{2}\NormalTok{], }\DecValTok{3}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{imagenet\_preprocess\_input}\NormalTok{()}

\NormalTok{  layer\_outputs }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(model}\SpecialCharTok{$}\NormalTok{layers[activations\_layers], }\ControlFlowTok{function}\NormalTok{(layer) layer}\SpecialCharTok{$}\NormalTok{output)}
\NormalTok{  activation\_model }\OtherTok{\textless{}{-}} \FunctionTok{keras\_model}\NormalTok{(}\AttributeTok{inputs =}\NormalTok{ model}\SpecialCharTok{$}\NormalTok{input, }\AttributeTok{outputs =}\NormalTok{ layer\_outputs)}
\NormalTok{  activations }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(activation\_model,img)}
  \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(activations))\{}
\NormalTok{    activations }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(activations)}
\NormalTok{  \}}

  \CommentTok{\#function for plotting one channel of a layer, adopted from: Chollet (2018): }
  \CommentTok{\# "Deep learning with R"}
\NormalTok{  plot\_channel }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(channel,layer\_name,channel\_name) \{}
\NormalTok{    rotate }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{t}\NormalTok{(}\FunctionTok{apply}\NormalTok{(x, }\DecValTok{2}\NormalTok{, rev))}
    \FunctionTok{image}\NormalTok{(}\FunctionTok{rotate}\NormalTok{(channel), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{asp =} \DecValTok{1}\NormalTok{,}
          \AttributeTok{col =} \FunctionTok{terrain.colors}\NormalTok{(}\DecValTok{12}\NormalTok{),}\AttributeTok{main=}\FunctionTok{paste}\NormalTok{(}\StringTok{"layer:"}\NormalTok{,layer\_name,}\StringTok{"channel:"}\NormalTok{,channel\_name))}
\NormalTok{  \}}

  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(activations)) \{}
\NormalTok{    layer\_activation }\OtherTok{\textless{}{-}}\NormalTok{ activations[[i]]}
\NormalTok{    layer\_name }\OtherTok{\textless{}{-}}\NormalTok{ model}\SpecialCharTok{$}\NormalTok{layers[[activations\_layers[i]]]}\SpecialCharTok{$}\NormalTok{name}
\NormalTok{    n\_features }\OtherTok{\textless{}{-}} \FunctionTok{dim}\NormalTok{(layer\_activation)[[}\DecValTok{4}\NormalTok{]]}
    \ControlFlowTok{for}\NormalTok{ (c }\ControlFlowTok{in}\NormalTok{ channels)\{}

\NormalTok{      channel\_image }\OtherTok{\textless{}{-}}\NormalTok{ layer\_activation[}\DecValTok{1}\NormalTok{,,,c]}
      \FunctionTok{plot\_channel}\NormalTok{(channel\_image,layer\_name,c)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

448 x 448 pixel subsets of the mask of Bahrain streets as well as of the
satellite image were created as the basis for building the model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inputrst }\OtherTok{=} \FunctionTok{stack}\NormalTok{(}\StringTok{"data/training\_unet/bahrain\_2021.tif"}\NormalTok{)}
\NormalTok{inputrst\_mask }\OtherTok{=} \FunctionTok{raster}\NormalTok{(}\StringTok{"data/training\_unet/street\_mask.tif"}\NormalTok{)}
\CommentTok{\# Create subsets of Bahrain and Street mask}
\FunctionTok{dl\_subsets}\NormalTok{(}\AttributeTok{inputrst =}\NormalTok{ inputrst, }\AttributeTok{targetsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }
           \AttributeTok{targetdir =} \StringTok{"data/training\_unet/imgs/"}\NormalTok{)}
\FunctionTok{dl\_subsets}\NormalTok{(}\AttributeTok{inputrst =}\NormalTok{ inputrst\_mask, }\AttributeTok{targetsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }
           \AttributeTok{targetdir =} \StringTok{"data/training\_unet/masks/"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The build model was trained on 70\% of the training data and validated
on the remaining 30\% in 15 epochs.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
   
  \CommentTok{\#get paths}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{img =} \FunctionTok{list.files}\NormalTok{(}\StringTok{"data/training\_unet/imgs/"}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.jpg"}\NormalTok{),}
    \AttributeTok{mask =} \FunctionTok{list.files}\NormalTok{(}\StringTok{"data/training\_unet/masks/"}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.jpg"}\NormalTok{)}
\NormalTok{  )}
  
  \CommentTok{\# split the data into training and validation datasets.}
  
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{initial\_split}\NormalTok{(files, }\AttributeTok{prop =} \FloatTok{0.7}\NormalTok{)}
  
  \CommentTok{\# prepare data for training}
\NormalTok{  training\_dataset }\OtherTok{\textless{}{-}} \FunctionTok{dl\_prepare\_data}\NormalTok{(}\FunctionTok{training}\NormalTok{(files),}\AttributeTok{train =} \ConstantTok{TRUE}\NormalTok{,}
                                      \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{),}\AttributeTok{batch\_size =}\NormalTok{ 10L)}
\NormalTok{  validation\_dataset }\OtherTok{\textless{}{-}} \FunctionTok{dl\_prepare\_data}\NormalTok{(}\FunctionTok{testing}\NormalTok{(files),}\AttributeTok{train =} \ConstantTok{FALSE}\NormalTok{,}
                                        \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{),}\AttributeTok{batch\_size =}\NormalTok{ 10L)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
   
  \CommentTok{\# get all tensors through the python iterator}
\NormalTok{  training\_tensors }\OtherTok{\textless{}{-}}\NormalTok{ training\_dataset}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{as\_iterator}\NormalTok{()}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{iterate}\NormalTok{()}
  
  \CommentTok{\#how many tensors?}
  \FunctionTok{length}\NormalTok{(training\_tensors)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
   
  \FunctionTok{compile}\NormalTok{(}
\NormalTok{    pretrained\_unet,}
    \AttributeTok{optimizer =} \FunctionTok{optimizer\_rmsprop}\NormalTok{(}\AttributeTok{lr =} \FloatTok{1e{-}5}\NormalTok{),}
    \AttributeTok{loss =} \StringTok{"binary\_crossentropy"}\NormalTok{,}
    \AttributeTok{metrics =} \FunctionTok{c}\NormalTok{(metric\_binary\_accuracy)}
\NormalTok{    )}
  
  
\NormalTok{  diagnostics }\OtherTok{\textless{}{-}} \FunctionTok{fit}\NormalTok{(pretrained\_unet,}
\NormalTok{                 training\_dataset,}
                 \AttributeTok{epochs =} \DecValTok{15}\NormalTok{,}
                 \AttributeTok{validation\_data =}\NormalTok{ validation\_dataset)}
  
  \FunctionTok{plot}\NormalTok{(diagnostics)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# we saved the diagnostics to a png file to save computation time}
\FunctionTok{include\_graphics}\NormalTok{(}\StringTok{"images/diagnostics.png"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=6.67in]{images/diagnostics} 

}

\caption{Diagonstics of model training}\label{fig:plot diagnostics}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \textless{}p style="text{-}align: center;"\textgreater{}![Diagonstics of model training](images/diagnostics.png)\textless{}/p\textgreater{}}
\end{Highlighting}
\end{Shaded}

The diagnostics display a valid model. With a binary accuracy of up to
0.83 and a loss of 0.17 for the training dataset after 15 epochs, the
model is well explained. The validation data support this.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
\NormalTok{  sample }\OtherTok{\textless{}{-}} \FunctionTok{floor}\NormalTok{(}\FunctionTok{runif}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{,}\AttributeTok{min =} \DecValTok{1}\NormalTok{,}\AttributeTok{max =} \DecValTok{4}\NormalTok{))}
\NormalTok{    img\_path }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{testing}\NormalTok{(files)[[sample,}\DecValTok{1}\NormalTok{]])}
\NormalTok{    mask\_path }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{testing}\NormalTok{(files)[[sample,}\DecValTok{2}\NormalTok{]])}
\NormalTok{    img }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(img\_path)}
\NormalTok{    mask }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(mask\_path)}
\NormalTok{    pred }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(}\FunctionTok{as.raster}\NormalTok{(}\FunctionTok{predict}\NormalTok{(}\AttributeTok{object =}\NormalTok{ pretrained\_unet,}
\NormalTok{                                                 validation\_dataset)[sample,,,]))}
  
\NormalTok{    out }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_append}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{    magick}\SpecialCharTok{::}\FunctionTok{image\_append}\NormalTok{(mask, }\AttributeTok{stack =} \ConstantTok{TRUE}\NormalTok{),}
\NormalTok{    magick}\SpecialCharTok{::}\FunctionTok{image\_append}\NormalTok{(img, }\AttributeTok{stack =} \ConstantTok{TRUE}\NormalTok{),}
\NormalTok{    magick}\SpecialCharTok{::}\FunctionTok{image\_append}\NormalTok{(pred, }\AttributeTok{stack =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  )}
  
  \FunctionTok{plot}\NormalTok{(out)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\includegraphics{images/prediction_sample.png}

An example of one subset is shown. The image on the left shows the
ground truth of the street mask, while the image in the middle is the
input subset of a satellite image from Bahrain. The picture on the right
shows the prediction of the model. It is clearly visible that our
algorithm is able to select streets and can select especially larger
streets with a good confidence. Smaller streets which are max. 3m wide
have a lower probability of being detected. The lines are not so clearly
visible.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
  \FunctionTok{save\_model\_hdf5}\NormalTok{(pretrained\_unet,}\AttributeTok{filepath =} \StringTok{"./pretrained\_unet.h5"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"pretrained\_unet.h5"}\NormalTok{))\{}
\NormalTok{  pretrained\_unet }\OtherTok{\textless{}{-}} \FunctionTok{load\_model\_hdf5}\NormalTok{(}\StringTok{"./pretrained\_unet.h5"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Street Prediction for 2017}
\NormalTok{input\_img }\OtherTok{=} \FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{)}
\CommentTok{\# Crashes the r Session if image is too large}
\NormalTok{raster\_cropped\_17 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_subsets}\NormalTok{(}\AttributeTok{inputrst =}\NormalTok{ input\_img, }\AttributeTok{targetsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }
                                \AttributeTok{targetdir =} \StringTok{"data/testarea\_unet/2017\_subsets/"}\NormalTok{)}
\NormalTok{test\_dataset\_17 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_prepare\_data}\NormalTok{(}\AttributeTok{train =}\NormalTok{ F,}\AttributeTok{predict =}\NormalTok{ T,}
                                   \AttributeTok{subsets\_path=}\StringTok{"./data/testarea\_unet/2017\_subsets/"}\NormalTok{,}
                                   \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{),}\AttributeTok{batch\_size =}\NormalTok{ 5L)}
\FunctionTok{system.time}\NormalTok{(predictions\_17 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(pretrained\_unet,test\_dataset\_17))}
\CommentTok{\# Let´s check the result on the map. We will again use the method for }
\CommentTok{\# reassembling the subsets to the final map, which you will see later.}
\FunctionTok{rebuild\_img}\NormalTok{(predictions\_17,}\AttributeTok{out\_path =} \StringTok{"./data/testarea\_unet/2017\_"}\NormalTok{,}
            \AttributeTok{target\_rst =}\NormalTok{ raster\_cropped\_17)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{input\_img }\OtherTok{=} \FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2019.tif"}\NormalTok{)}
\NormalTok{raster\_cropped\_19 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_subsets}\NormalTok{(}\AttributeTok{inputrst =}\NormalTok{ input\_img, }\AttributeTok{targetsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }
                                \AttributeTok{targetdir =} \StringTok{"data/testarea\_unet/2019\_subsets/"}\NormalTok{)}
\NormalTok{test\_dataset\_19 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_prepare\_data}\NormalTok{(}\AttributeTok{train =}\NormalTok{ F,}\AttributeTok{predict =}\NormalTok{ T,}
                                   \AttributeTok{subsets\_path=}\StringTok{"./data/testarea\_unet/2019\_subsets/"}\NormalTok{,}
                                   \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{),}\AttributeTok{batch\_size =}\NormalTok{ 5L)}
\FunctionTok{system.time}\NormalTok{(predictions\_19 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(pretrained\_unet,test\_dataset\_19))}
\FunctionTok{rebuild\_img}\NormalTok{(predictions\_19,}\AttributeTok{out\_path =} \StringTok{"./data/testarea\_unet/2019\_"}\NormalTok{,}
            \AttributeTok{target\_rst =}\NormalTok{ raster\_cropped\_19)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{input\_img }\OtherTok{=} \FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2021.tif"}\NormalTok{)}
\NormalTok{raster\_cropped\_21 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_subsets}\NormalTok{(}\AttributeTok{inputrst =}\NormalTok{ input\_img, }\AttributeTok{targetsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{), }
                                \AttributeTok{targetdir =} \StringTok{"data/testarea\_unet/2021\_subsets/"}\NormalTok{)}
\NormalTok{test\_dataset\_21 }\OtherTok{\textless{}{-}} \FunctionTok{dl\_prepare\_data}\NormalTok{(}\AttributeTok{train =}\NormalTok{ F,}\AttributeTok{predict =}\NormalTok{ T,}
                                   \AttributeTok{subsets\_path=}\StringTok{"./data/testarea\_unet/2021\_subsets/"}\NormalTok{,}
                                   \AttributeTok{model\_input\_shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{448}\NormalTok{,}\DecValTok{448}\NormalTok{),}\AttributeTok{batch\_size =}\NormalTok{ 5L)}
\FunctionTok{system.time}\NormalTok{(predictions\_21 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(pretrained\_unet,test\_dataset\_21))}
\FunctionTok{rebuild\_img}\NormalTok{(predictions\_21,}\AttributeTok{out\_path =} \StringTok{"./data/testarea\_unet/2021\_"}\NormalTok{,}
            \AttributeTok{target\_rst =}\NormalTok{ raster\_cropped\_21)}
\end{Highlighting}
\end{Shaded}

\hypertarget{results}{%
\section{Results}\label{results}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{read\_stars}\NormalTok{(}\StringTok{"./data/testarea\_unet/2017\_subsets/25.jpg"}\NormalTok{),}\AttributeTok{rgb=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## downsample set to c(1,1,1)
\end{verbatim}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/sample 25 2017-1} 

}

\caption{Sample image no 25. (2017)}\label{fig:sample 25 2017}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#visualize layers 3 and 10, channels 1 to 20}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow=}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{),}\AttributeTok{mar=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{cex=}\FloatTok{0.5}\NormalTok{)}
\FunctionTok{plot\_layer\_activations}\NormalTok{(}\AttributeTok{img\_path =} \StringTok{"./data/testarea\_unet/2017\_subsets/25.jpg"}\NormalTok{, }
                       \AttributeTok{model=}\NormalTok{pretrained\_unet ,}\AttributeTok{activations\_layers =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{5}\NormalTok{), }\AttributeTok{channels =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/activation layers 2017-1} 

}

\caption{Three activation layers of sample 25 (2017)}\label{fig:activation layers 2017}
\end{figure}

\hypertarget{compare-histograms}{%
\subsection{Compare Histograms}\label{compare-histograms}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result\_map\_21 }\OtherTok{\textless{}{-}} \FunctionTok{raster}\NormalTok{(}\StringTok{"./data/testarea\_unet/2021\_out/mosaic.tif"}\NormalTok{)}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{readAll}\NormalTok{()}
\FunctionTok{crs}\NormalTok{(result\_map\_21)}\OtherTok{=}\FunctionTok{crs}\NormalTok{(}\FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{))}
\NormalTok{result\_map\_21\_0}\FloatTok{.3}\NormalTok{NA }\OtherTok{=}\NormalTok{ result\_map\_21}
\NormalTok{result\_map\_21\_0}\FloatTok{.3}\NormalTok{NA[result\_map\_21\_0}\FloatTok{.3}\NormalTok{NA[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_21\_0}\FloatTok{.3}\NormalTok{NA), }\AttributeTok{main =} \StringTok{"Classified Street Pixels comparison"}\NormalTok{,}
     \AttributeTok{col =} \FunctionTok{rgb}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}\AttributeTok{xlab=}\StringTok{"street probability"}\NormalTok{)}

\NormalTok{result\_map\_17 }\OtherTok{\textless{}{-}} \FunctionTok{raster}\NormalTok{(}\StringTok{"./data/testarea\_unet/2017\_out/mosaic.tif"}\NormalTok{)}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{readAll}\NormalTok{()}
\FunctionTok{crs}\NormalTok{(result\_map\_17)}\OtherTok{=}\FunctionTok{crs}\NormalTok{(}\FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{))}
\NormalTok{result\_map\_17\_0}\FloatTok{.3}\NormalTok{NA }\OtherTok{=}\NormalTok{ result\_map\_17}
\NormalTok{result\_map\_17\_0}\FloatTok{.3}\NormalTok{NA[result\_map\_17\_0}\FloatTok{.3}\NormalTok{NA[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_17\_0}\FloatTok{.3}\NormalTok{NA),}\AttributeTok{col =} \FunctionTok{rgb}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{result\_map\_19 }\OtherTok{\textless{}{-}} \FunctionTok{raster}\NormalTok{(}\StringTok{"./data/testarea\_unet/2019\_out/mosaic.tif"}\NormalTok{)}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{readAll}\NormalTok{()}
\FunctionTok{crs}\NormalTok{(result\_map\_19)}\OtherTok{=}\FunctionTok{crs}\NormalTok{(}\FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{))}
\NormalTok{result\_map\_19\_0}\FloatTok{.3}\NormalTok{NA }\OtherTok{=}\NormalTok{ result\_map\_19}
\NormalTok{result\_map\_19\_0}\FloatTok{.3}\NormalTok{NA[result\_map\_19\_0}\FloatTok{.3}\NormalTok{NA[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\FunctionTok{hist}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_19\_0}\FloatTok{.3}\NormalTok{NA),}\AttributeTok{col =} \FunctionTok{rgb}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\AttributeTok{add =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{legend}\NormalTok{(}\StringTok{"topright"}\NormalTok{, }\AttributeTok{inset=}\NormalTok{.}\DecValTok{02}\NormalTok{, }\AttributeTok{title=}\StringTok{"Year"}\NormalTok{,}
   \FunctionTok{c}\NormalTok{(}\StringTok{"2017"}\NormalTok{,}\StringTok{"2019"}\NormalTok{,}\StringTok{"2021"}\NormalTok{), }\AttributeTok{fill=}\FunctionTok{c}\NormalTok{(}\FunctionTok{rgb}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}\FunctionTok{rgb}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}\FunctionTok{rgb}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{)), }
   \AttributeTok{horiz=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{cex=}\FloatTok{0.8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/compare histogram-1} 

}

\caption{Histogram of pixel values}\label{fig:compare histogram}
\end{figure}

In the Figure `Classified Street Pixels comparison' it can be seen that
street pixels have more than doubled from 2021 - 2017 and are stable
between 2017 and 2019. This leads to the assumption that there must be a
construction boom between 2019 and 2021. This assumption is solidified
when analyzing the images below.

\begin{center}\includegraphics[width=1\linewidth]{final_assignment_files/figure-latex/unnamed-chunk-3-1} \end{center}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot prediction results-1} 

}

\caption{Street pixel probabilities (left), satellite image (right)}\label{fig:plot prediction results}
\end{figure}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot prediction results development-1} 

}

\caption{Development}\label{fig:plot prediction results development}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result\_map\_2017\_binary }\OtherTok{=}\NormalTok{ result\_map\_17}
\NormalTok{result\_map\_2017\_binary[result\_map\_2017\_binary}\SpecialCharTok{\textgreater{}=}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{1}
\NormalTok{result\_map\_2017\_binary[result\_map\_2017\_binary}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{0}

\NormalTok{result\_map\_2019\_binary }\OtherTok{=}\NormalTok{ result\_map\_19}
\NormalTok{result\_map\_2019\_binary[result\_map\_2019\_binary}\SpecialCharTok{\textgreater{}=}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{1}
\NormalTok{result\_map\_2019\_binary[result\_map\_2019\_binary}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{0}

\NormalTok{result\_map\_2021\_binary }\OtherTok{=}\NormalTok{ result\_map\_21}
\NormalTok{result\_map\_2021\_binary[result\_map\_2021\_binary}\SpecialCharTok{\textgreater{}=}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{1}
\NormalTok{result\_map\_2021\_binary[result\_map\_2021\_binary}\SpecialCharTok{\textless{}}\FloatTok{0.3}\NormalTok{] }\OtherTok{=} \DecValTok{0}

\NormalTok{pal }\OtherTok{\textless{}{-}} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{,}\StringTok{"red"}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow=}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(result\_map\_2017\_binary, }\AttributeTok{main =} \StringTok{"2017"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(result\_map\_2021\_binary }\SpecialCharTok{{-}}\NormalTok{ result\_map\_2017\_binary, }\AttributeTok{main=}\StringTok{"2017 {-} 2021"}\NormalTok{, }
     \AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{col\_pal}\NormalTok{(}\DecValTok{3}\NormalTok{))}

\FunctionTok{plot}\NormalTok{(result\_map\_2019\_binary, }\AttributeTok{main =} \StringTok{"2019"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(result\_map\_2021\_binary }\SpecialCharTok{{-}}\NormalTok{ result\_map\_2019\_binary, }\AttributeTok{main=}\StringTok{"2019 {-} 2021"}\NormalTok{, }
     \AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{col\_pal}\NormalTok{(}\DecValTok{3}\NormalTok{))}

\FunctionTok{plot}\NormalTok{(result\_map\_2021\_binary, }\AttributeTok{main =} \StringTok{"2021"}\NormalTok{, }\AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(result\_map\_2019\_binary }\SpecialCharTok{{-}}\NormalTok{ result\_map\_2017\_binary, }\AttributeTok{main=}\StringTok{"2017 {-} 2019"}\NormalTok{, }
     \AttributeTok{legend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{col\_pal}\NormalTok{(}\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/plot binary prediction results-1} 

}

\caption{Binary classifaction (left), development (right)}\label{fig:plot binary prediction results}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# compare pixel sums}
\NormalTok{sum\_17 }\OtherTok{=} \FunctionTok{cellStats}\NormalTok{(result\_map\_2017\_binary, }\StringTok{"sum"}\NormalTok{)}
\NormalTok{sum\_19 }\OtherTok{=} \FunctionTok{cellStats}\NormalTok{(result\_map\_2019\_binary, }\StringTok{"sum"}\NormalTok{)}
\NormalTok{sum\_21 }\OtherTok{=} \FunctionTok{cellStats}\NormalTok{(result\_map\_2021\_binary, }\StringTok{"sum"}\NormalTok{)}
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Total amount of street pixels in 2017: \%i, 2019: \%i and 2021 \%i"}\NormalTok{, sum\_17, sum\_19, sum\_21)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Total amount of street pixels in 2017: 176478, 2019: 169973 and 2021 387852"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sum\_21\_17 }\OtherTok{=} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2021\_binary)) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2017\_binary))}
\NormalTok{sum\_21\_19 }\OtherTok{=} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2021\_binary)) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2019\_binary))}
\NormalTok{sum\_19\_17 }\OtherTok{=} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2019\_binary)) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(}\FunctionTok{values}\NormalTok{(result\_map\_2017\_binary))}
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"2021 the number fo street pixels is \%f times of the amount in 2017 and \%f times of the amount in 2019."}\NormalTok{, sum\_21\_17, sum\_21\_19)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2021 the number fo street pixels is 2.197736 times of the amount in 2017 and 2.281845 times of the amount in 2019."
\end{verbatim}

The 2017-2019, 2017-2021, and 2019-2021 images show the change between a
newly added road (dark green) to roads that are no longer there (white).
Again, it is noticeable that the number of dark green roads is higher in
2017-2021 and 2019-2021. The value between 2017-2021 seems to be
justified with the boom between 2019-2021. Furthermore, it is noticeable
that some roads are classified as a change to no road, which are again
labeled as new roads in later years. From 2017-2021 east of the stadium,
another main road seems to occur. In the western part indications of a
settlement structure can be seen. Overall, it is noticeable that around
the stadium an intensification and densification of streets can be seen.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{mar=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{plotRGB}\NormalTok{(}\FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2017.tif"}\NormalTok{),}\AttributeTok{r=}\DecValTok{1}\NormalTok{,}\AttributeTok{b=}\DecValTok{3}\NormalTok{, }\AttributeTok{main=}\StringTok{"Doha 2017"}\NormalTok{)}
\FunctionTok{plotRGB}\NormalTok{(}\FunctionTok{stack}\NormalTok{(}\StringTok{"data/testarea\_unet/doha\_2021.tif"}\NormalTok{),}\AttributeTok{r=}\DecValTok{1}\NormalTok{,}\AttributeTok{b=}\DecValTok{3}\NormalTok{, }\AttributeTok{main=}\StringTok{"Doha 2021"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{final_assignment_files/figure-latex/view rgb of doha from 2017 to 2019-1} 

}

\caption{Doha 2017 (top), Doha 2021 (bottom)}\label{fig:view rgb of doha from 2017 to 2019}
\end{figure}

The satellite images from 2017 (Figure 4) and 2021 (Figure 5) show that
the horizontal main road in the north of the Khalifa stadium was under
construction in 2017 and finished in 2021. This is visible in our
2017-2021 plot.

The removed streets on the top right of Figure 4 are displayed in our
prediction as well. The road was extended to a highway, so roundabouts
and junctions were removed.

A new street area in the west of the stadium can be partly seen in our
prediction-difference plots. This shows an opportunity to enhance our
model and to calibrate and train it in a more detailed way. This applies
as well for streets in residential areas. Here might be differences
because of streets that are made from soil and sand instead of asphalt.
So, it is harder to distinguish the street from other areas. A second
suggestion is that the 3m resolution of the Planet satellite images is
not enough. A street might be less than 3m and cannot be detected or is
influenced, e.g.~by a house standing next to it and sharing the same
pixel. Depending on the inclination angle of the satellite, houses,
trees and other high things might cover the street at some parts, so the
pixel cannot be identified as a street in 2017. In 2021 there was a
different angle and different pixels could be identified.

\hypertarget{conclusion}{%
\section{Conclusion}\label{conclusion}}

Our model is able to detect streets and changes in the street
infrastructure in a desert state like Qatar. It is able to show areas
where streets were removed and where streets were built. Only the
residential areas could be improved. However, this is most likely not a
bug in our model but a problem in the satellite data such as covering,
subsurface and tilt angle for solar radiation.

\hypertarget{lessons-learned}{%
\section{Lessons Learned}\label{lessons-learned}}

Our group chose the study project mainly because we did not have the
opportunity to work with deep learning during our study time. We were
very interested in how to set up such a network. In previous courses we
were able to run unsupervised and supervised classifications but usually
in a very small area. With the beginning of the course we had to learn
how to handle Amazon Elastic Compute Cloud (Amazon EC2) instances. We
usually used R Studio only on a local instance and not as the
server-based version.

With that came different challenges: On the one hand it was difficult to
identify errors with a terminating instance. Supervising RAM and storage
usage had to be established and learned. On the other hand, we had to
figure out how much space our model will need when processing a certain
amount of data. After extending the size of the RAM on our server and
reducing the image size, we were able to run the model within 20 minutes
for 15 episodes. It usually was quite tricky to run the model with too
large files because then the content of the RAM got lost and we had to
run all code chunks again.

After establishing the models and training our model with data from
Bahrain, we did a first prediction on satellite images from Doha. The
results were very bad, as we realized that we had to choose exactly the
same type of image from the same satellite with almost the same solar
radiation and RGB values.

comparing images that are of the same product (equal value range) is
easier than of different products

We were also able to expand our experience in handling validations with
models. On the one hand, the process was consolidated and, on the other,
it became clear once again how important it is to use the right test and
training data. The selection of the cities of Doha and Bahrain proved to
be very useful, as it did not overfit the model.

The project could, of course, be expanded. We would have liked to do a
mulitclass detection to see which steps would be necessary and to have a
comparison between the different detections. Additionally, it would be
interesting to see how the prediction works with a larger section, but
this would require much more memory. Also, the street growth results
could be compared to actual planning data for the city of Doha. However,
this is beyond the scope of a feasible study project.

\hypertarget{plan-and-group-organization}{%
\section{Plan and Group
Organization}\label{plan-and-group-organization}}

With the beginning of the project we planned to identify the growth and
enhancement of infrastructure around the stadiums. After some research,
we figured out that most stadiums are around the capital city Doha. We
decided to cover the whole city. To detect a growth of infrastructure,
we chose streets as indicators. Whenever a building is built a street
needs to connect it. We planned to detect the streets with a binary
classification. In a second step we wanted to do a more specific
multiclass detection of streets, water, and recreation areas. We decided
to have an eye on images in 2017, 2019 and 2021.

We introduced ourselves to the classification with convolutional neural
networks using u-net and \emph{tensorflow} following the guide of the
OGH Summer School 2020 (Christian Knoth 2020). With this training we
were able to establish a model for our binary classification. We
realized that we need a second area for training our model. We decided
to train with data from Bahrain and were able to use OSM street data as
our ground truth. We were able to train our model in time.

We started with a blockwise binary classification of the area with a
focus on streets where we could see first changes. Afterwards, we began
to establish the pixel wise binary classification. Due to a larger
amount of data that needed to be considered, the \emph{AWS} instance
could not handle our classification anymore. In the first step, our RAM
was increased by the lecturers but we still had to downsize the area of
detection. We then chose the area around the Khalifa stadium in an outer
area of Doha called Ar-Rayyan. Since we were not used to \emph{AWS}, it
took us a while to identify missing RAM space as the issue of our error.

As a result, we were behind the schedule and it was no longer possible
to create a mature multiclass detection. We therefore decided to focus
on the binary classification and tried our analysis with different
images. Since we used non processed satellite images, the solar
radiation mattered.

During the semester we usually met every Monday at 10am to work together
on the classification. On Wednesdays we had our class where we were able
to ask questions and present our proceedings. Due to the COVID-19
pandemic, all meetings were entirely online. Since only one person at a
time was able to access the \emph{AWS} instance, one shared the screen
while another person took notes and the third one googled all questions.

\hypertarget{references}{%
\section{References}\label{references}}

\hypertarget{refs}{}
\begin{CSLReferences}{1}{0}
\leavevmode\hypertarget{ref-Keras}{}%
Allaire, JJ, and François Chollet. 2021. \emph{Keras: R Interface to
'Keras'}. \url{https://CRAN.R-project.org/package=keras}.

\leavevmode\hypertarget{ref-TensorFlow}{}%
Allaire, JJ, and Yuan Tang. 2021. \emph{Tensorflow: R Interface to
'TensorFlow'}. \url{https://CRAN.R-project.org/package=tensorflow}.

\leavevmode\hypertarget{ref-tfdatasets}{}%
Allaire, JJ, Yuan Tang, and Kevin Ushey. 2021. \emph{Tfdatasets:
Interface to 'TensorFlow' Datasets}.
\url{https://CRAN.R-project.org/package=tfdatasets}.

\leavevmode\hypertarget{ref-mapview}{}%
Appelhans, Tim, Florian Detsch, Christoph Reudenbach, and Stefan
Woellauer. 2021. \emph{Mapview: Interactive Viewing of Spatial Data in
r}. \url{https://CRAN.R-project.org/package=mapview}.

\leavevmode\hypertarget{ref-benjaminBest}{}%
Benjamin Best. 2021. {``Katar: Neue Studie Belegt Ausbeutung von
Arbeitern in Der Hotelbranche.''}
\url{https://www.sportschau.de/fussball/fifa-wm-2022/fussball-wm-katar-studie-arbeiter-hotelbranche-100.html}.

\leavevmode\hypertarget{ref-ChristianKnoth.2020}{}%
Christian Knoth. 2020. {``Introduction to Deep Learning in r for the
Analysis of UAV-Based Remote Sensing Data.''}
\url{https://dachro.github.io/ogh_summer_school_2020/Tutorial_DL_UAV.html}.

\leavevmode\hypertarget{ref-purrr}{}%
Henry, Lionel, and Hadley Wickham. 2020. \emph{Purrr: Functional
Programming Tools}. \url{https://CRAN.R-project.org/package=purrr}.

\leavevmode\hypertarget{ref-raster}{}%
Hijmans, Robert J. 2021a. \emph{Raster: Geographic Data Analysis and
Modeling}. \url{https://CRAN.R-project.org/package=raster}.

\leavevmode\hypertarget{ref-terra}{}%
---------. 2021b. \emph{Terra: Spatial Data Analysis}.
\url{https://CRAN.R-project.org/package=terra}.

\leavevmode\hypertarget{ref-OlafRonneberger.2015}{}%
Olaf Ronneberger, Philipp Fischer, and Thomas Brox. 2015. {``U-Net:
Convolutional Networks for Biomedical Image Segmentation.''} In,
234--41. {Springer, Cham}.
\url{https://doi.org/10.1007/978-3-319-24574-4\%7B/textunderscore\%20\%7D28}.

\leavevmode\hypertarget{ref-OpenStreetMap}{}%
OpenStreetMap contributors. 2017. {``{Planet dump retrieved from
https://planet.osm.org
}.''}\href{\%20https://www.openstreetmap.org\%20}{ https://www.openstreetmap.org}.

\leavevmode\hypertarget{ref-stars}{}%
Pebesma, Edzer. 2021. \emph{Stars: Spatiotemporal Arrays, Raster and
Vector Data Cubes}. \url{https://CRAN.R-project.org/package=stars}.

\leavevmode\hypertarget{ref-QGISDevelopmentTeam.2021}{}%
QGIS Development Team. 2021. {``QGIS Geographic Information System.''}
\url{https://www.qgis.org}.

\leavevmode\hypertarget{ref-R}{}%
R Core Team. 2021. \emph{R: A Language and Environment for Statistical
Computing}. Vienna, Austria: R Foundation for Statistical Computing.
\url{https://www.R-project.org/}.

\leavevmode\hypertarget{ref-rsample}{}%
Silge, Julia, Fanny Chow, Max Kuhn, and Hadley Wickham. 2021.
\emph{Rsample: General Resampling Infrastructure}.
\url{https://CRAN.R-project.org/package=rsample}.

\leavevmode\hypertarget{ref-Stern}{}%
Stern. 2021. {``Das Stadion, Das für Die WM in Katar Gebaut Wird- Und
Direkt Wieder Abgerissen Werden Soll.''}
\url{https://www.stern.de/sport/fussball/wm-2022-in-katar--neugebautes-stadion-soll-sofort-wieder-verschwinden-30623560.html}.

\leavevmode\hypertarget{ref-TheGuardian.2021}{}%
The Guardian. 2021. {``Reveald: 6,500 Migrant Workers Have Died in Qatar
Since World Cup Awared.''}
\url{https://www.theguardian.com/global-development/2021/feb/23/revealed-migrant-worker-deaths-qatar-fifa-world-cup-2022}.

\leavevmode\hypertarget{ref-kicker}{}%
Tobias Rudolf. 2021. {``Bundesminister müller Zu Nachhaltigkeit Und
ökologie Im Fußball.''}
\url{https://www.kicker.de/das-waere-doch-der-geniale-kontrapunkt-zur-wm-in-katar-790502/artikel}.

\leavevmode\hypertarget{ref-tz}{}%
tz. 2021. {``WM 2022: Mit Dieser Aussage Macht Katar Der Welt
Hoffnung.''}
\url{https://www.tz.de/sport/fussball/wm-2022-mit-dieser-aussage-macht-katar-welt-hoffnung-zr-10361250.html}.

\leavevmode\hypertarget{ref-reticulate}{}%
Ushey, Kevin, JJ Allaire, and Yuan Tang. 2021. \emph{Reticulate:
Interface to 'Python'}.
\url{https://CRAN.R-project.org/package=reticulate}.

\leavevmode\hypertarget{ref-ggplot2}{}%
Wickham, Hadley. 2016. \emph{Ggplot2: Elegant Graphics for Data
Analysis}. Springer-Verlag New York.
\url{https://ggplot2.tidyverse.org}.

\leavevmode\hypertarget{ref-dplyr}{}%
Wickham, Hadley, Romain François, Lionel Henry, and Kirill Müller. 2021.
\emph{Dplyr: A Grammar of Data Manipulation}.
\url{https://CRAN.R-project.org/package=dplyr}.

\leavevmode\hypertarget{ref-knitrman}{}%
Xie, Yihui. 2021. \emph{Knitr: A General-Purpose Package for Dynamic
Report Generation in r}. \url{https://yihui.org/knitr/}.

\end{CSLReferences}

\hypertarget{appendices}{%
\section{Appendices}\label{appendices}}

\hypertarget{used-software}{%
\subsection{Used software}\label{used-software}}

All plots were created, and computations were done using QGIS 3.10.4
(QGIS Development Team 2021) and R 4.1.0 (R Core Team 2021) with the
following packages:

\begin{itemize}
\tightlist
\item
  \emph{keras} 2.4.0 (Allaire and Chollet 2021)
\item
  \emph{tensorflow} 2.5.0 (Allaire and Tang 2021)
\item
  \emph{tfdatasets} 2.4.0 (Allaire, Tang, and Ushey 2021)
\item
  \emph{purrr} 0.3.4 (Henry and Wickham 2020)
\item
  \emph{ggplot2} 3.3.5 (Wickham 2016)
\item
  \emph{rsample} 0.1.0 (Silge et al. 2021)
\item
  \emph{stars} 0.5-3 (Pebesma 2021)
\item
  \emph{terra} 1.3-4 (Hijmans 2021b)
\item
  \emph{raster} 3.4-13 (Hijmans 2021a)
\item
  \emph{reticulate} 1.20 (Ushey, Allaire, and Tang 2021)
\item
  \emph{mapview} 2.10.0 (Appelhans et al. 2021)
\item
  \emph{dplyr} 1.0.7 (Wickham et al. 2021)
\item
  \emph{knitr} 1.33 (Xie 2021)
\end{itemize}

\end{document}
